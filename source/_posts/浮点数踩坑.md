---
title: 浮点数踩坑
categories:
  - 疑难杂症
top: 99
tags:
  - 浮点数
abbrlink: d533c7c1
---



[利用BigDecimal类巧妙处理Double类型精度丢失](https://www.cnblogs.com/summerday152/p/14202267.html)



<!-- more -->

## 问题案例

```kotlin
val d = 103.765
val formatter = NumberFormat.getNumberInstance() //返回的是DecimalFormat类
formatter.roundingMode = RoundingMode.HALF_UP
formatter.maximumFractionDigits = 2
formatter.minimumFractionDigits = 2
formatter.isGroupingUsed = false
val result = formatter.format(d)   //结果是 103.76 并不是103.77
```

上面代码想实现 【四舍五入，保留两位小数】的功能，结果却和预期不一样



## 问题分析

查看DecimalFormat类format方法原理

```java
public final StringBuffer format(Object number,
                                 StringBuffer toAppendTo,
                                 FieldPosition pos) {
    if (number instanceof Long || number instanceof Integer ||
        number instanceof Short || number instanceof Byte ||
        number instanceof AtomicInteger ||
        number instanceof AtomicLong ||
        (number instanceof BigInteger &&
         ((BigInteger)number).bitLength () < 64)) {
        return format(((Number)number).longValue(), toAppendTo, pos);
    } else if (number instanceof BigDecimal) {
        return format((BigDecimal)number, toAppendTo, pos);
    } else if (number instanceof BigInteger) {
        return format((BigInteger)number, toAppendTo, pos);
    } else if (number instanceof Number) {  //传入的是float，走到了这里 
        return format(((Number)number).doubleValue(), toAppendTo, pos);
    } else {
        throw new IllegalArgumentException("Cannot format given Object as a Number");
    }
}

```

可以看见 ，传入float时，会强转为Number类调用doubleValue方法获得值进行后续操作；就是float转double出现精度丢失

> 103.765变成了 103.76499938964844，再四舍五入 就变成了 103.76



## 问题解决

> 使用 BigDecimal类

```kotlin
val d = 103.765
val formatter = NumberFormat.getNumberInstance()
formatter.roundingMode = RoundingMode.HALF_UP
formatter.maximumFractionDigits = 2
formatter.minimumFractionDigits = 2
formatter.isGroupingUsed = false
val result = formatter.format(BigDecimal("$d")) //正常返回 103.77

```















Keep Moving Forward
