---
title: 崩溃知识点
categories:
  - 知识点
tags:
  - 崩溃
abbrlink: '30488343'
---





一个java层捕捉崩溃的写法



## 手动进行消息的loop，并捕捉异常

```kotlin
private static void startCatchLooper() {
    new Handler(Looper.getMainLooper()).post(() -> {
        while (true) {
            loopInner();
        }
    });
}

private static void loopInner() {
    try {
        Looper.loop();
    } catch (Throwable e) {
        if (e.getMessage() != null) {
            Message message = getMessage();
            //如果忽略该异常，则直接return，否则继续抛出Throwable
            if(catch(message,e)){
                return;
            }else{
                throw e;
            }
        }
    }
```



## 获得当前执行的Message

```kotlin
private static Message getMessage() {
    MessageQueue messageQueue;
    Looper mainLooper = Looper.getMainLooper();
    try {
        if (Build.VERSION.SDK_INT >= 23) {
            messageQueue = mainLooper.getQueue();
        } else {
            Field fieldQueue = Looper.class.getDeclaredField("mQueue");
            fieldQueue.setAccessible(true);
            messageQueue = (MessageQueue) fieldQueue.get(mainLooper);
        }
        Field fieldMessages = MessageQueue.class.getDeclaredField("mMessages");
        fieldMessages.setAccessible(true);
        return (Message) fieldMessages.get(messageQueue);
    } catch (Throwable ignored) {
        //
    }
    return null;
}
```



Keep Moving Forward
