---
title: 协程知识点
categories:
  - 知识点
tags:
  - 协程
abbrlink: 58bbdd0e
---



## 1.Flow 的collect的正常用法

```kotlin
mainScope.launch {
    flow.collect {
        //do something
    }
}
mainScope.launch {
    flow2.collect {
        //do something
    }
}
```

 flow的collect是个suspend函数，内部逻辑是个while(true)死循环，所以不能在collect之后写任何代码，因为执行不到 



<!-- more -->



下面为 **SharedFlowImpl** 的代码

```
override suspend fun collect(collector: FlowCollector<T>): Nothing {
    val slot = allocateSlot()
    try {
        if (collector is SubscribedFlowCollector) collector.onSubscription()
        val collectorJob = currentCoroutineContext()[Job]
        while (true) {
            var newValue: Any?
            while (true) {
                newValue = tryTakeValue(slot) // attempt no-suspend fast path first
                if (newValue !== NO_VALUE) break
                awaitValue(slot) // await signal that the new value is available
            }
            collectorJob?.ensureActive()
            collector.emit(newValue as T)
        }
    } finally {
        freeSlot(slot)
    }
}
```



<font color='red'>如果需要collect一个flow，需要单独起一个协程，该协程内只能collect一个flow，不能在collect函数后面加任何代码</font>





Keep Moving Forward
